var W=t=>{throw TypeError(t)};var j=(t,e,n)=>e.has(t)||W("Cannot "+n);var i=(t,e,n)=>(j(t,e,"read from private field"),n?n.call(t):e.get(t)),c=(t,e,n)=>e.has(t)?W("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,n),d=(t,e,n,r)=>(j(t,e,"write to private field"),r?r.call(t,n):e.set(t,n),n),b=(t,e,n)=>(j(t,e,"access private method"),n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();const q={BASE_URL:"https://story-api.dicoding.dev/v1"},z={GET_ALL_STORIES:`${q.BASE_URL}/stories?location=1`,LOGIN:`${q.BASE_URL}/login`,REGISTER:`${q.BASE_URL}/register`};async function ce(t){return(await(await fetch(z.GET_ALL_STORIES,{headers:{Authorization:`Bearer ${t}`}})).json()).listStory}async function le(t,e){const r=await(await fetch(z.LOGIN,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,password:e})})).json();if(r.error)throw new Error(r.message);return r}async function de(t,e,n){const o=await(await fetch(z.REGISTER,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,email:e,password:n})})).json();if(o.error)throw new Error(o.message);return o}const $=(t,e)=>e.some(n=>t instanceof n);let K,J;function ue(){return K||(K=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function me(){return J||(J=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const H=new WeakMap,F=new WeakMap,N=new WeakMap;function he(t){const e=new Promise((n,r)=>{const o=()=>{t.removeEventListener("success",s),t.removeEventListener("error",a)},s=()=>{n(w(t.result)),o()},a=()=>{r(t.error),o()};t.addEventListener("success",s),t.addEventListener("error",a)});return N.set(e,t),e}function ge(t){if(H.has(t))return;const e=new Promise((n,r)=>{const o=()=>{t.removeEventListener("complete",s),t.removeEventListener("error",a),t.removeEventListener("abort",a)},s=()=>{n(),o()},a=()=>{r(t.error||new DOMException("AbortError","AbortError")),o()};t.addEventListener("complete",s),t.addEventListener("error",a),t.addEventListener("abort",a)});H.set(t,e)}let V={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return H.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return w(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function ee(t){V=t(V)}function pe(t){return me().includes(t)?function(...e){return t.apply(G(this),e),w(this.request)}:function(...e){return w(t.apply(G(this),e))}}function fe(t){return typeof t=="function"?pe(t):(t instanceof IDBTransaction&&ge(t),$(t,ue())?new Proxy(t,V):t)}function w(t){if(t instanceof IDBRequest)return he(t);if(F.has(t))return F.get(t);const e=fe(t);return e!==t&&(F.set(t,e),N.set(e,t)),e}const G=t=>N.get(t);function ye(t,e,{blocked:n,upgrade:r,blocking:o,terminated:s}={}){const a=indexedDB.open(t,e),u=w(a);return r&&a.addEventListener("upgradeneeded",l=>{r(w(a.result),l.oldVersion,l.newVersion,w(a.transaction),l)}),n&&a.addEventListener("blocked",l=>n(l.oldVersion,l.newVersion,l)),u.then(l=>{s&&l.addEventListener("close",()=>s()),o&&l.addEventListener("versionchange",m=>o(m.oldVersion,m.newVersion,m))}).catch(()=>{}),u}const we=["get","getKey","getAll","getAllKeys","count"],be=["put","add","delete","clear"],_=new Map;function Q(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(_.get(e))return _.get(e);const n=e.replace(/FromIndex$/,""),r=e!==n,o=be.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(o||we.includes(n)))return;const s=async function(a,...u){const l=this.transaction(a,o?"readwrite":"readonly");let m=l.store;return r&&(m=m.index(u.shift())),(await Promise.all([m[n](...u),o&&l.done]))[0]};return _.set(e,s),s}ee(t=>({...t,get:(e,n,r)=>Q(e,n)||t.get(e,n,r),has:(e,n)=>!!Q(e,n)||t.has(e,n)}));const ve=["continue","continuePrimaryKey","advance"],Y={},U=new WeakMap,te=new WeakMap,Le={get(t,e){if(!ve.includes(e))return t[e];let n=Y[e];return n||(n=Y[e]=function(...r){U.set(this,te.get(this)[e](...r))}),n}};async function*Se(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,Le);for(te.set(n,e),N.set(n,G(e));e;)yield n,e=await(U.get(n)||e.continue()),U.delete(n)}function X(t,e){return e===Symbol.asyncIterator&&$(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&$(t,[IDBIndex,IDBObjectStore])}ee(t=>({...t,get(e,n,r){return X(e,n)?Se:t.get(e,n,r)},has(e,n){return X(e,n)||t.has(e,n)}}));const Ee="story-database",Ie=1,v="stories",C=ye(Ee,Ie,{upgrade(t){t.objectStoreNames.contains(v)||t.createObjectStore(v,{keyPath:"id"})}}),Z={async add(t){return(await C).add(v,t)},async getAll(){return(await C).getAll(v)},async delete(t){return(await C).delete(v,t)},async clear(){return(await C).clear(v)}};var h,T;class ke{constructor({view:e,token:n}){c(this,h);c(this,T);d(this,h,e),d(this,T,n)}async showStories(){try{const e=await ce(i(this,T));if(!e||!Array.isArray(e)||e.length===0){i(this,h).showEmptyState();return}for(const n of e)await Z.add(n).catch(()=>{});i(this,h).showStoriesOnList(e),i(this,h).showStoriesOnMap(e)}catch(e){console.warn("Gagal mengambil dari API, mencoba ambil dari IndexedDB:",e);const n=await Z.getAll();!n||n.length===0?i(this,h).showEmptyState():(i(this,h).showStoriesOnList(n),i(this,h).showStoriesOnMap(n))}}}h=new WeakMap,T=new WeakMap;var D;class Be{constructor(){c(this,D)}async render(){return`
      <section class="container">
        <h1>Beranda Cerita</h1>
        <div id="story-list" class="story-list">Memuat cerita...</div>

        <h2 style="margin-top: 40px;">Peta Cerita</h2>
        <div id="map" style="height: 400px; margin-top: 16px; border-radius: 8px;"></div>
      </section>
    `}async afterRender(){const e=localStorage.getItem("authToken");if(!e){const n=document.querySelector("#story-list");n.innerHTML='<p>Anda belum login. Silakan <a href="#/login">login</a> terlebih dahulu.</p>';return}d(this,D,new ke({view:this,token:e})),await i(this,D).showStories()}showStoriesOnList(e){const n=document.querySelector("#story-list");n.innerHTML=e.map(r=>`
      <article class="story-item">
        <img src="${r.photoUrl}" alt="Foto cerita oleh ${r.name}" class="story-image" />
        <h2>${r.name}</h2>
        <p>${r.description}</p>
        <small>Dibuat pada: ${new Date(r.createdAt).toLocaleDateString()}</small>
      </article>
    `).join("")}showStoriesOnMap(e){const n=document.getElementById("map");n._leaflet_id&&(n._leaflet_id=null,n.innerHTML="");const r=L.map("map").setView([-2.5489,118.0149],4);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(r),e.forEach(o=>{o.lat&&o.lon&&L.marker([o.lat,o.lon]).addTo(r).bindPopup(`<strong>${o.name}</strong><br>${o.description}`)})}showEmptyState(){const e=document.querySelector("#story-list");e.innerHTML="<p>Tidak ada cerita ditemukan.</p>"}showErrorState(){const e=document.querySelector("#story-list");e.innerHTML="<p>Gagal memuat cerita. Silakan coba lagi nanti.</p>"}}D=new WeakMap;class Pe{async render(){return`
      <section class="container">
        <h1>About Page</h1>
      </section>
    `}async afterRender(){}}var S;class Te{constructor(e){c(this,S);d(this,S,e)}async login(e,n){try{const r=await le(e,n);i(this,S).onLoginSuccess(r)}catch(r){i(this,S).onLoginError(r.message)}}}S=new WeakMap;var M;class De{constructor(){c(this,M)}async render(){return`
      <section class="container">
        <h1>Login</h1>
        <form id="login-form">
          <label for="email">Email</label>
          <input type="email" id="email" required />

          <label for="password">Password</label>
          <input type="password" id="password" required minlength="8" />

          <button type="submit">Masuk</button>
        </form>
        <div id="login-message"></div>
        <p style="margin-top: 10px;">Belum punya akun? <a href="#/register">Daftar di sini</a>.</p>
      </section>
    `}async afterRender(){d(this,M,new Te(this));const e=document.querySelector("#login-form");e.addEventListener("submit",n=>{n.preventDefault();const r=e.email.value,o=e.password.value;i(this,M).login(r,o)})}onLoginSuccess(e){localStorage.setItem("authToken",e.loginResult.token),document.getElementById("login-message").textContent="Login berhasil!",setTimeout(()=>{window.updateNav(),location.hash="#/"},1e3)}onLoginError(e){document.getElementById("login-message").textContent="Login gagal: "+e}}M=new WeakMap;var p,A,E,y,I,g,ne,re,oe,se;class Me{constructor({view:e,token:n}){c(this,g);c(this,p);c(this,A);c(this,E,null);c(this,y,null);c(this,I,null);d(this,p,e),d(this,A,n)}async initialize(){b(this,g,ne).call(this),await b(this,g,re).call(this),b(this,g,oe).call(this),b(this,g,se).call(this)}}p=new WeakMap,A=new WeakMap,E=new WeakMap,y=new WeakMap,I=new WeakMap,g=new WeakSet,ne=function(){const e=L.map("map").setView([-2.5,118],4);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(e);const n=L.icon({iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34]});e.on("click",r=>{const{lat:o,lng:s}=r.latlng;document.getElementById("lat").value=o,document.getElementById("lon").value=s,i(this,I)&&i(this,I).remove(),d(this,I,L.marker([o,s],{icon:n}).addTo(e).bindPopup(`<strong>Lokasi dipilih:</strong><br>${o.toFixed(5)}, ${s.toFixed(5)}`).openPopup())})},re=async function(){try{d(this,y,await navigator.mediaDevices.getUserMedia({video:!0}));const e=document.getElementById("camera-video");e.srcObject=i(this,y)}catch(e){console.error("Tidak dapat mengakses kamera:",e),i(this,p).showMessage("Tidak dapat mengakses kamera.","error")}},oe=function(){const e=document.getElementById("snapshot-canvas"),n=document.getElementById("camera-video"),r=document.getElementById("capture-btn"),o=document.getElementById("preview-image");r.addEventListener("click",()=>{const s=e.getContext("2d");e.width=n.videoWidth,e.height=n.videoHeight,s.drawImage(n,0,0),e.toBlob(a=>{if(!a){i(this,p).showMessage("Gagal menangkap gambar.","error");return}d(this,E,a),o&&(o.src=URL.createObjectURL(a),o.style.display="block"),i(this,y)&&i(this,y).getTracks().forEach(u=>u.stop())},"image/jpeg")})},se=function(){const e=document.getElementById("add-story-form");e.addEventListener("submit",async n=>{n.preventDefault();const r=document.getElementById("description").value,o=document.getElementById("lat").value,s=document.getElementById("lon").value;if(!i(this,E)||!r){i(this,p).showMessage("Foto dan deskripsi wajib diisi.","error");return}const a=new File([i(this,E)],"snapshot.jpg",{type:"image/jpeg"}),u=new FormData;u.append("description",r),u.append("photo",a),o&&s&&(u.append("lat",o),u.append("lon",s));try{const l=await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:`Bearer ${i(this,A)}`},body:u}),m=await l.json();if(l.ok)i(this,p).showMessage(m.message||"Cerita berhasil dikirim!"),e.reset(),setTimeout(()=>{location.hash="#/"},1e3);else throw new Error(m.message||"Gagal mengirim cerita.")}catch(l){console.error(l),i(this,p).showMessage("Gagal mengirim cerita.","error")}})};var O;class Ae{constructor(){c(this,O)}async render(){return`
      <section class="container">
        <h1>Tambah Cerita Baru</h1>

        <form id="add-story-form">
          <label for="description">Deskripsi</label>
          <textarea id="description" rows="4" required></textarea>

          <label>Ambil Foto dari Kamera</label>
          <video id="camera-video" autoplay playsinline style="width: 100%; max-width: 400px; border-radius: 8px;"></video>
          <p style="font-size: 0.9rem; color: #555; margin-top: 6px;">Cukup 1 klik untuk ambil foto.</p>
          <button type="button" id="capture-btn">Ambil Foto</button>
          <canvas id="snapshot-canvas" style="display: none;"></canvas>
          <img id="preview-image" style="display: none; width: 100%; margin-top: 1rem; border-radius: 8px;" />

          <label>Lokasi</label>
          <div id="map" style="height: 300px; margin-bottom: 1rem;"></div>
          <input type="hidden" id="lat" />
          <input type="hidden" id="lon" />

          <button type="submit">Kirim Cerita</button>
        </form>

        <div id="submit-message"></div>
      </section>
    `}async afterRender(){const e=localStorage.getItem("authToken");if(!e){const n=document.querySelector(".container");n.innerHTML=`
        <p>Anda belum login. Silakan <a href="#/login">login</a> terlebih dahulu.</p>
      `;return}d(this,O,new Me({view:this,token:e})),await i(this,O).initialize()}showMessage(e,n="success"){const r=document.getElementById("submit-message");r.style.color=n==="success"?"green":"red",r.textContent=e}}O=new WeakMap;var k;class Oe{constructor(e){c(this,k);d(this,k,e)}async register(e,n,r){try{await de(e,n,r),i(this,k).onRegisterSuccess()}catch(o){i(this,k).onRegisterError(o.message)}}}k=new WeakMap;var x;class xe{constructor(){c(this,x)}async render(){return`
      <section class="container">
        <h1>Register</h1>
        <form id="register-form">
          <label for="name">Nama</label>
          <input type="text" id="name" required />

          <label for="email">Email</label>
          <input type="email" id="email" required />

          <label for="password">Password</label>
          <input type="password" id="password" required minlength="8" />

          <button type="submit">Daftar</button>
        </form>
        <div id="register-message"></div>
      </section>
    `}async afterRender(){d(this,x,new Oe(this));const e=document.querySelector("#register-form");e.addEventListener("submit",n=>{n.preventDefault();const r=e.name.value,o=e.email.value,s=e.password.value;i(this,x).register(r,o,s)})}onRegisterSuccess(){const e=document.getElementById("register-message");e.style.color="green",e.textContent="Registrasi berhasil! Silakan login.",location.hash="#/login"}onRegisterError(e){const n=document.getElementById("register-message");n.style.color="red",n.textContent="Gagal daftar: "+e}}x=new WeakMap;const Ce={"/":new Be,"/about":new Pe,"/register":new xe,"/login":new De,"/add":new Ae};function Re(t){const e=t.split("/");return{resource:e[1]||null,id:e[2]||null}}function Ne(t){let e="";return t.resource&&(e=e.concat(`/${t.resource}`)),t.id&&(e=e.concat("/:id")),e||"/"}function je(){return location.hash.replace("#","")||"/"}function qe(){const t=je(),e=Re(t);return Ne(e)}var B,P,f,R,ie;class Fe{constructor({navigationDrawer:e,drawerButton:n,content:r}){c(this,R);c(this,B,null);c(this,P,null);c(this,f,null);d(this,B,r),d(this,P,n),d(this,f,e),b(this,R,ie).call(this)}async renderPage(){const e=qe(),n=Ce[e];document.startViewTransition?await document.startViewTransition(async()=>{i(this,B).innerHTML=await n.render(),await n.afterRender()}):(i(this,B).innerHTML=await n.render(),await n.afterRender())}}B=new WeakMap,P=new WeakMap,f=new WeakMap,R=new WeakSet,ie=function(){i(this,P).addEventListener("click",()=>{i(this,f).classList.toggle("open")}),document.body.addEventListener("click",e=>{!i(this,f).contains(e.target)&&!i(this,P).contains(e.target)&&i(this,f).classList.remove("open"),i(this,f).querySelectorAll("a").forEach(n=>{n.contains(e.target)&&i(this,f).classList.remove("open")})})};function ae(){const t=localStorage.getItem("authToken"),e=document.querySelector("#nav-list");if(!e)return;e.innerHTML="",t?e.innerHTML=`
      <li><a href="#/">Beranda</a></li>
      <li><a href="#/about">About</a></li>
      <li><a href="#/add">Tambah Cerita</a></li>
      <li><a href="#" id="logout-link">Keluar</a></li>
    `:e.innerHTML=`
      <li><a href="#/login">Masuk</a></li>
      <li><a href="#/">Beranda</a></li>
      <li><a href="#/about">About</a></li>
    `;const n=document.querySelector("#logout-link");n&&n.addEventListener("click",()=>{localStorage.removeItem("authToken"),location.hash="#/login",ae()})}window.updateNav=ae;document.addEventListener("DOMContentLoaded",async()=>{const t=localStorage.getItem("authToken"),e=location.hash==="#/login";if(!t&&!e){location.hash="#/login";return}const n=new Fe({content:document.querySelector("#main-content"),drawerButton:document.querySelector("#drawer-button"),navigationDrawer:document.querySelector("#navigation-drawer")});window.updateNav(),await n.renderPage();const r=document.querySelector(".skip-link"),o=document.querySelector("#main-content");r.addEventListener("click",function(s){s.preventDefault(),r.blur(),o.focus(),o.scrollIntoView()}),window.addEventListener("hashchange",async()=>{const s=localStorage.getItem("authToken"),u=["#/login","#/register"].includes(location.hash);if(!s&&!u){location.hash="#/login";return}await n.renderPage(),window.updateNav()})});async function _e(t){if(await Notification.requestPermission()!=="granted")return;const n=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:"BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk"}),r=localStorage.getItem("authToken");if(!r)return;const o={endpoint:n.endpoint,keys:{p256dh:n.toJSON().keys.p256dh,auth:n.toJSON().keys.auth}};await fetch("https://story-api.dicoding.dev/v1/notifications/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(o)})}window.addEventListener("load",async()=>{if("serviceWorker"in navigator)try{const t=await navigator.serviceWorker.register("/berbagiCerita/sw.js");await _e(t)}catch(t){console.error(" Service Worker registration failed:",t)}});
